<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,900">
<style>
  body {font-family: "Lato", sans-serif}
  #dropboard {
    border-radius: 15px;
    border: 2px #AAA dashed;
    font-weight: bold;
  }
  #dropboard:hover {
    border-color: #888;
  }
  .punch-line {
    border-top: 2px #AAA dashed;
  }
</style>
</head>
<body>
<div class="w3-top">
  <div class="w3-bar w3-black w3-card">
    <a href="#brunsli" class="w3-bar-item w3-button w3-padding-large">Brunsli</a>
    <a href="#demo" class="w3-bar-item w3-button w3-padding-large">Demo</a>
  </div>
</div>

<div class="w3-content" style="max-width:2000px;margin-top:46px">
  <div class="w3-light-gray" id="brunsli"><div class="w3-container w3-content w3-center" style="max-width:800px">
    <h2 class="w3-wide">Brusnli</h2>
    <p class="w3-justify">Some Inspiring text.</p>
  </div></div>

  <div id="demo"><div class="w3-container w3-content w3-center" style="max-width:800px">
    <h2 class="w3-wide">Demo</h2>
    <div class="w3-input w3-button w3-large dropboard" id="dropboard">
      <div class="w3-xlarge">â‡©</div>
      <div style="opacity: 0;font-size: 0; margin: -7.5px">
        <input type="file" id="fileSelector" name="files[]" multiple />
      </div>
      Drop your .jpg or .brn files here.
    </div>
    <div class="w3-justify" id="output"></div>
  </div></div>

  <div class="w3-margin-bottom"></div>
</div>

<script type="text/javascript">
var Module = {};
let dropboard = document.getElementById('dropboard');
let fileSelector = document.getElementById('fileSelector');
let output = document.getElementById('output');
function onDragOver(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  evt.dataTransfer.dropEffect = 'copy';
}
function onDrop(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  processFiles(evt.dataTransfer.files);
}
function onClick(evt) {
  if (evt.button) return;
  if (!evt.isTrusted) return;  // stop recursion
  evt.stopPropagation();
  evt.preventDefault();
  let click = document.createEvent('MouseEvents');
  click.initEvent('click', true, false);
  fileSelector.dispatchEvent(click);
}
function onFileSelect(evt) {
  processFiles(evt.target.files);
}
function processFiles(files) {
  output.innerHTML = '';
  for (var i = 0, f; f = files[i]; i++) processFile(f);
}
function processFile(file) {
  let fileName = file.name;
  let fileType = file.type;
  let reader = new FileReader();
  reader.onload = (e) => {
    let bytes = e.target.result;
    let size = bytes.byteLength;
    var bytesView = new Uint8Array(bytes);
    let data = Module._malloc(size);
    Module.HEAPU8.set(bytesView, data);
    if (fileType == 'image/jpeg') {
      processJpeg(fileName, data, size);
    } else {
      processBrunsli(fileName, data, size);
    }
    Module._free(data);
    log('punch-line', []);
  };
  reader.readAsArrayBuffer(file);
}
function log(clazz, content) {
  let line = document.createElement('div');
  line.className = clazz;
  for (node of content) line.appendChild(node);
  output.appendChild(line);
}
function text(str) {
  return document.createTextNode(str);
}
function logDownloadLink(fileName, fileContent) {
  let t0 = text("Click the ");
  let t1 = text("link");
  let t2 = text(" to dowload the result.");
  let l1 = document.createElement('a');
  l1.appendChild(t1);
  let chars = [];
  for (let i = 0; i < fileContent.length; ++i) {
    chars.push(String.fromCharCode(fileContent[i]));
  }
  l1.setAttribute('href', 'data:application/octet-stream;base64,' + btoa(chars.join('')));
  l1.setAttribute('download', fileName);
  log('w3-text-black', [t0, l1, t2]);
}
function processJpeg(fileName, jpegData, jpegSize) {
  log('w3-text-gray', [text("Processing " + fileName + " as JPEG")]);
  log('w3-text-gray', [text("Input size: " + jpegSize)]);
  let brunsli = Module._JpegToBrunsli(jpegData, jpegSize);
  if (!brunsli) {
    log('w3-text-red', text("Brunsli compression failed"));
    return;
  }
  let brunsliData = Module._GetBrunsliData(brunsli);
  let brunsliSize = Module._GetBrunsliLength(brunsli);
  let brunsliDataView = new Uint8Array(Module.HEAPU8.subarray(brunsliData, brunsliData + brunsliSize));
  let output = new Uint8Array(brunsliSize);
  output.set(brunsliDataView);
  Module._FreeBrunsli(brunsli);
  log('w3-text-gray', [text("Output size: " + brunsliSize)]);
  logDownloadLink(fileName + '.brn', output);
}
function processBrunsli(fileName, brunsliData, brunsliSize) {
  log('w3-text-gray', [text("Processing " + fileName + " as Brunsli")]);
  log('w3-text-gray', [text("Input size: " + brunsliSize)]);
  let jpeg = Module._BrunsliToJpeg(brunsliData, brunsliSize);
  if (!jpeg) {
    log('w3-text-red', text("Brunsli decompression failed"));
    return;
  }
  let jpegData = Module._GetJpegData(jpeg);
  let jpegSize = Module._GetJpegLength(jpeg);
  let jpegDataView = new Uint8Array(Module.HEAPU8.subarray(jpegData, jpegData + jpegSize));
  let output = new Uint8Array(jpegSize);
  output.set(jpegDataView);
  Module._FreeBrunsli(jpeg);
  log('w3-text-gray', [text("Output size: " + jpegSize)]);
  logDownloadLink(fileName + '.jpg', output);
}
document.addEventListener('DOMContentLoaded', () => {
dropboard.addEventListener('dragover', onDragOver, false);
dropboard.addEventListener('drop', onDrop, false);
dropboard.addEventListener('click', onClick, false);
fileSelector.addEventListener('change', onFileSelect, false);
});
</script>
<script type="text/javascript" src="brunslicodec-wasm.js"></script>
</body>
</html>